<!-- (c) diyyo 2025 MIT License -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget by diyyo</title>
    <link
      rel="shortcut icon"
      href="../assets/img/budget.png"
      type="image/x-icon"
    />
    <meta name="description" content="Aplikasi catatan keuangan pribadi.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Catatan Keuangan">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2956/2966711.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/2956/2966711.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://cdn-icons-png.flaticon.com/512/2956/2966711.png">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .toast {
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .loading-spinner {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }
        .quick-add-btn {
            transition: all 0.2s ease;
        }
        .quick-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .description-item {
            transition: all 0.2s ease;
        }
        .description-item:hover {
            background-color: #f3f4f6;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Mobile-specific styles */
        @media (max-width: 640px) {
            .modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
                max-height: 85vh;
            }
            .stats-card {
                padding: 1rem;
            }
            .stats-icon {
                width: 2.5rem;
                height: 2.5rem;
            }
            .table-container {
                font-size: 0.875rem;
            }
            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            .pagination-container {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }
        }
        /* Higher z-index for transaction modal when opened from admin panel */
        .transaction-modal-high-z {
            z-index: 60 !important;
        }
        /* Ban notification modal */
        .ban-notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .ban-notification-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .ban-notification-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }
        /* Install button styles */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .install-button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }
        .install-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Install Button (hidden by default) -->
    <button id="installButton" class="install-button hidden">
        <i class="fas fa-download mr-2"></i> Install Aplikasi
    </button>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2 max-w-xs sm:max-w-sm"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center hidden p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Budget by diyyo</h1>
            <p class="text-gray-600 text-center mb-8">Silakan login untuk melanjutkan</p>
            <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center">
                <i class="fab fa-google mr-2"></i> Login dengan Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <h1 class="text-lg sm:text-xl font-bold text-gray-800">Budget by diyyo</h1>
                    <div class="flex gap-2">
                        <button id="adminBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center whitespace-nowrap hidden">
                            <i class="fas fa-user-shield mr-2"></i> Admin
                        </button>
                        <button id="logoutBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center justify-center whitespace-nowrap">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-4 sm:py-6 sm:px-6 lg:px-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 lg:gap-6 mb-4 sm:mb-6">
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 stats-card">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600 stats-icon flex-shrink-0">
                            <i class="fas fa-arrow-up text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0">
                            <p class="text-xs sm:text-sm text-gray-600 truncate">Pemasukan</p>
                            <p id="totalIncome" class="text-base sm:text-lg font-bold truncate">Rp 0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 stats-card">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-red-100 text-red-600 stats-icon flex-shrink-0">
                            <i class="fas fa-arrow-down text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0">
                            <p class="text-xs sm:text-sm text-gray-600 truncate">Pengeluaran</p>
                            <p id="totalExpense" class="text-base sm:text-lg font-bold truncate">Rp 0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 stats-card sm:col-span-2 lg:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600 stats-icon flex-shrink-0">
                            <i class="fas fa-wallet text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0">
                            <p class="text-xs sm:text-sm text-gray-600 truncate">Saldo Total</p>
                            <p id="totalBalance" class="text-base sm:text-lg font-bold truncate">Rp 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Count Card -->
            <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-purple-100 text-purple-600 stats-icon flex-shrink-0">
                            <i class="fas fa-list-alt text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0">
                            <p class="text-xs sm:text-sm text-gray-600 truncate">Total Transaksi</p>
                            <p id="totalTransactions" class="text-base sm:text-lg font-bold truncate">0</p>
                        </div>
                    </div>
                    <div class="flex gap-4 sm:gap-6">
                        <div class="text-center">
                            <p class="text-xs sm:text-sm text-gray-600">Pemasukan</p>
                            <p id="incomeCount" class="text-base font-medium text-green-600">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs sm:text-sm text-gray-600">Pengeluaran</p>
                            <p id="expenseCount" class="text-base font-medium text-red-600">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col gap-3">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Cari transaksi..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-sm">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex gap-2">
                            <select id="typeFilter" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="all">Semua Jenis</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                            <select id="sortSelect" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="date-desc">Tanggal (Terbaru)</option>
                                <option value="date-asc">Tanggal (Terlama)</option>
                                <option value="amount-desc">Jumlah (Terbesar)</option>
                                <option value="amount-asc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 action-buttons">
                        <button id="descriptionsBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-list mr-2"></i> Daftar Keterangan
                        </button>
                        <button id="addTransactionBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Tambah Transaksi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden mb-4 sm:mb-6">
                <div class="overflow-x-auto table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Transactions will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="hidden text-center py-8 sm:py-12">
                    <i class="fas fa-receipt text-gray-300 text-4xl sm:text-5xl mb-4"></i>
                    <p class="text-gray-500 text-sm sm:text-base">Belum ada transaksi</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between pagination-container">
                <div class="text-sm text-gray-700 mb-3 sm:mb-0 text-center">
                    Menampilkan <span id="startItem">0</span> - <span id="endItem">0</span> dari <span id="totalItems">0</span> transaksi
                </div>
                <div class="flex justify-center">
                    <div class="flex space-x-1 sm:space-x-2">
                        <button id="prevPageBtn" class="px-2 sm:px-3 py-1 border rounded-lg bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left text-xs"></i>
                        </button>
                        <div id="pageNumbers" class="flex space-x-1">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button id="nextPageBtn" class="px-2 sm:px-3 py-1 border rounded-lg bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-lg sm:text-xl font-bold text-gray-800">Tambah Transaksi</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <div class="mb-4">
                        <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="transactionDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div class="mb-4">
                        <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <div class="flex">
                            <input type="text" id="transactionDescription" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" required>
                            <div class="relative">
                                <button type="button" id="descriptionDropdownBtn" class="bg-gray-100 hover:bg-gray-200 border border-l-0 border-gray-300 rounded-r-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <i class="fas fa-chevron-down text-sm"></i>
                                </button>
                                <div id="descriptionDropdown" class="absolute right-0 mt-1 w-48 bg-white border border-gray-300 rounded-lg shadow-lg z-10 hidden">
                                    <div class="max-h-60 overflow-y-auto">
                                        <!-- Description options will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="saveDescription" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="text-sm text-gray-700">Simpan keterangan ini di dalam daftar keterangan</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Jenis</label>
                        <select id="transactionType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                        <input type="number" id="transactionAmount" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" min="0" step="100">
                    </div>
                    <div class="mb-6">
                        <p class="text-sm font-medium text-gray-700 mb-2">Quick Add</p>
                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="500">
                                0.5k
                            </button>
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="1000">
                                1k
                            </button>
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="5000">
                                5k
                            </button>
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="10000">
                                10k
                            </button>
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="50000">
                                50k
                            </button>
                            <button type="button" class="quick-add-btn bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-lg" data-value="100000">
                                100k
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:justify-end gap-3">
                        <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium order-2 sm:order-1">Batal</button>
                        <button type="submit" id="saveTransactionBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium order-1 sm:order-2">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Descriptions Modal -->
    <div id="descriptionsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Daftar Keterangan</h3>
                    <button id="closeDescriptionsModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <div class="flex">
                        <input type="text" id="newDescriptionInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Tambah keterangan baru...">
                        <button id="addDescriptionBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-2 rounded-r-lg">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <div id="descriptionsList" class="bg-gray-50 rounded-lg p-3 sm:p-4 max-h-96 overflow-y-auto">
                        <!-- Descriptions will be inserted here -->
                    </div>
                    <div id="descriptionsEmpty" class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                        <p class="text-sm">Belum ada keterangan tersimpan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Administrator Panel</h3>
                    <button id="closeAdminModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-8">
                        <button id="usersTabBtn" class="tab-btn py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Manage Users
                        </button>
                        <button id="transactionsTabBtn" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            All Transactions
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content -->
                <div id="usersTabContent" class="tab-content">
                    <!-- Search and Filter -->
                    <div class="mb-4">
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input type="text" id="adminUserSearch" placeholder="Cari user..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-sm">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <select id="adminUserFilter" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="all">Semua User</option>
                                <option value="active">Aktif</option>
                                <option value="banned">Dibanned</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="adminUsersEmpty" class="hidden text-center py-8 sm:py-12">
                        <i class="fas fa-users text-gray-300 text-4xl sm:text-5xl mb-4"></i>
                        <p class="text-gray-500 text-sm sm:text-base">Tidak ada user ditemukan</p>
                    </div>
                </div>
                
                <div id="transactionsTabContent" class="tab-content hidden">
                    <!-- User Selection Header -->
                    <div id="userSelectionHeader" class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <div>
                                <p class="text-sm font-medium text-blue-800">Menampilkan transaksi untuk:</p>
                                <p id="selectedUserInfo" class="text-sm text-blue-600">Semua User</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="selectUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded-lg">
                                    <i class="fas fa-user mr-1"></i> Pilih User
                                </button>
                                <button id="addTransactionForUserBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-1 px-3 rounded-lg">
                                    <i class="fas fa-plus mr-1"></i> Tambah Transaksi
                                </button>
                                <button id="viewAllTransactionsBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium py-1 px-3 rounded-lg hidden">
                                    <i class="fas fa-list mr-1"></i> Lihat Semua
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="mb-4">
                        <div class="flex flex-col gap-3">
                            <div class="relative">
                                <input type="text" id="adminTransactionSearch" placeholder="Cari transaksi..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-sm">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <div class="flex gap-2">
                                <select id="adminTypeFilter" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="all">Semua Jenis</option>
                                    <option value="income">Pemasukan</option>
                                    <option value="expense">Pengeluaran</option>
                                </select>
                                <select id="adminSortSelect" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="date-desc">Tanggal (Terbaru)</option>
                                    <option value="date-asc">Tanggal (Terlama)</option>
                                    <option value="amount-desc">Jumlah (Terbesar)</option>
                                    <option value="amount-asc">Jumlah (Terkecil)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminTransactionsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Transactions will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="adminTransactionsEmpty" class="hidden text-center py-8 sm:py-12">
                        <i class="fas fa-receipt text-gray-300 text-4xl sm:text-5xl mb-4"></i>
                        <p class="text-gray-500 text-sm sm:text-base">Tidak ada transaksi ditemukan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div id="banUserModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Ban User</h3>
                    <button id="closeBanUserModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="banUserForm">
                    <input type="hidden" id="banUserId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User</label>
                        <p id="banUserInfo" class="text-sm text-gray-900"></p>
                    </div>
                    <div class="mb-4">
                        <label for="banReason" class="block text-sm font-medium text-gray-700 mb-1">Alasan Ban</label>
                        <textarea id="banReason" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" required></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:justify-end gap-3">
                        <button type="button" id="cancelBanBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium order-2 sm:order-1">Batal</button>
                        <button type="submit" id="confirmBanBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium order-1 sm:order-2">Ban User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Select User Modal -->
    <div id="selectUserModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Pilih User</h3>
                    <button id="closeSelectUserModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="selectUserSearch" placeholder="Cari user..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-sm">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="mb-4">
                    <div id="selectUserList" class="bg-gray-50 rounded-lg p-3 sm:p-4 max-h-96 overflow-y-auto">
                        <!-- Users will be inserted here -->
                    </div>
                    <div id="selectUserEmpty" class="text-center py-8 text-gray-500">
                        <i class="fas fa-users text-4xl mb-2"></i>
                        <p class="text-sm">Tidak ada user ditemukan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban Notification Modal (will be created dynamically) -->
    <div id="banNotificationContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "API_KEY",
            authDomain: "AUTH_DOMAIN",
            databaseURL: "DATABASE_URL",
            projectId: "PROJ_ID",
            storageBucket: "STRG_BUCKET",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID",
            measurementId: "MEA_ID",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginSection = document.getElementById('loginSection');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminBtn = document.getElementById('adminBtn');
        const descriptionsBtn = document.getElementById('descriptionsBtn');
        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const transactionModal = document.getElementById('transactionModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const transactionForm = document.getElementById('transactionForm');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');
        const modalTitle = document.getElementById('modalTitle');
        const transactionId = document.getElementById('transactionId');
        const transactionDate = document.getElementById('transactionDate');
        const transactionDescription = document.getElementById('transactionDescription');
        const transactionType = document.getElementById('transactionType');
        const transactionAmount = document.getElementById('transactionAmount');
        const saveDescription = document.getElementById('saveDescription');
        const descriptionDropdownBtn = document.getElementById('descriptionDropdownBtn');
        const descriptionDropdown = document.getElementById('descriptionDropdown');
        const transactionsTableBody = document.getElementById('transactionsTableBody');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const sortSelect = document.getElementById('sortSelect');
        const totalBalance = document.getElementById('totalBalance');
        const totalIncome = document.getElementById('totalIncome');
        const totalExpense = document.getElementById('totalExpense');
        const totalTransactions = document.getElementById('totalTransactions');
        const incomeCount = document.getElementById('incomeCount');
        const expenseCount = document.getElementById('expenseCount');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageNumbers = document.getElementById('pageNumbers');
        const startItem = document.getElementById('startItem');
        const endItem = document.getElementById('endItem');
        const totalItems = document.getElementById('totalItems');
        const installButton = document.getElementById('installButton');
        
        // Descriptions Modal Elements
        const descriptionsModal = document.getElementById('descriptionsModal');
        const closeDescriptionsModalBtn = document.getElementById('closeDescriptionsModalBtn');
        const newDescriptionInput = document.getElementById('newDescriptionInput');
        const addDescriptionBtn = document.getElementById('addDescriptionBtn');
        const descriptionsList = document.getElementById('descriptionsList');
        const descriptionsEmpty = document.getElementById('descriptionsEmpty');
        
        // Admin Modal Elements
        const adminModal = document.getElementById('adminModal');
        const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');
        const usersTabBtn = document.getElementById('usersTabBtn');
        const transactionsTabBtn = document.getElementById('transactionsTabBtn');
        const usersTabContent = document.getElementById('usersTabContent');
        const transactionsTabContent = document.getElementById('transactionsTabContent');
        const adminUsersTableBody = document.getElementById('adminUsersTableBody');
        const adminUsersEmpty = document.getElementById('adminUsersEmpty');
        const adminTransactionsTableBody = document.getElementById('adminTransactionsTableBody');
        const adminTransactionsEmpty = document.getElementById('adminTransactionsEmpty');
        const userSelectionHeader = document.getElementById('userSelectionHeader');
        const selectedUserInfo = document.getElementById('selectedUserInfo');
        const selectUserBtn = document.getElementById('selectUserBtn');
        const addTransactionForUserBtn = document.getElementById('addTransactionForUserBtn');
        const viewAllTransactionsBtn = document.getElementById('viewAllTransactionsBtn');
        
        // Ban User Modal Elements
        const banUserModal = document.getElementById('banUserModal');
        const closeBanUserModalBtn = document.getElementById('closeBanUserModalBtn');
        const cancelBanBtn = document.getElementById('cancelBanBtn');
        const banUserForm = document.getElementById('banUserForm');
        const confirmBanBtn = document.getElementById('confirmBanBtn');
        
        // Select User Modal Elements
        const selectUserModal = document.getElementById('selectUserModal');
        const closeSelectUserModalBtn = document.getElementById('closeSelectUserModalBtn');
        const selectUserSearch = document.getElementById('selectUserSearch');
        const selectUserList = document.getElementById('selectUserList');
        const selectUserEmpty = document.getElementById('selectUserEmpty');

        // State
        let currentUser = null;
        let transactions = [];
        let filteredTransactions = [];
        let descriptions = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let isInitialized = false;
        let authChecked = false;
        let isAdmin = false;
        let allUsers = [];
        let allTransactions = [];
        let bannedUsers = [];
        let adminCurrentTab = 'users';
        let selectedUserForTransactions = null;
        let userEmails = {};
        let banNotificationListeners = {};
        let deferredPrompt = null;

        // Initialize app
        function initializeApp() {
            // Set today's date as default
            transactionDate.valueAsDate = new Date();

            // Event Listeners
            loginBtn.addEventListener('click', loginWithGoogle);
            logoutBtn.addEventListener('click', logout);
            adminBtn.addEventListener('click', openAdminModal);
            descriptionsBtn.addEventListener('click', openDescriptionsModal);
            addTransactionBtn.addEventListener('click', openAddModal);
            closeModalBtn.addEventListener('click', closeModal);
            closeDescriptionsModalBtn.addEventListener('click', closeDescriptionsModal);
            closeAdminModalBtn.addEventListener('click', closeAdminModal);
            closeBanUserModalBtn.addEventListener('click', closeBanUserModal);
            closeSelectUserModalBtn.addEventListener('click', closeSelectUserModal);
            cancelBtn.addEventListener('click', closeModal);
            cancelBanBtn.addEventListener('click', closeBanUserModal);
            transactionForm.addEventListener('submit', saveTransaction);
            banUserForm.addEventListener('submit', banUser);
            usersTabBtn.addEventListener('click', () => switchAdminTab('users'));
            transactionsTabBtn.addEventListener('click', () => switchAdminTab('transactions'));
            selectUserBtn.addEventListener('click', openSelectUserModal);
            addTransactionForUserBtn.addEventListener('click', addTransactionForSelectedUser);
            viewAllTransactionsBtn.addEventListener('click', viewAllTransactions);
            searchInput.addEventListener('input', debounce(filterTransactions, 300));
            typeFilter.addEventListener('change', filterTransactions);
            sortSelect.addEventListener('change', sortTransactions);
            prevPageBtn.addEventListener('click', () => changePage(currentPage - 1));
            nextPageBtn.addEventListener('click', () => changePage(currentPage + 1));

            // Descriptions modal event listeners
            addDescriptionBtn.addEventListener('click', addDescription);
            newDescriptionInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addDescription();
                }
            });

            // Description dropdown event listeners
            descriptionDropdownBtn.addEventListener('click', toggleDescriptionDropdown);

            // Quick add buttons event listeners
            const quickAddButtons = document.querySelectorAll('.quick-add-btn');
            quickAddButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    const currentValue = parseInt(transactionAmount.value) || 0;
                    transactionAmount.value = currentValue + value;
                    
                    // Add visual feedback
                    this.classList.add('bg-blue-100', 'text-blue-700');
                    setTimeout(() => {
                        this.classList.remove('bg-blue-100', 'text-blue-700');
                    }, 200);
                });
            });

            // Admin search and filter event listeners
            document.getElementById('adminUserSearch').addEventListener('input', debounce(filterAdminUsers, 300));
            document.getElementById('adminUserFilter').addEventListener('change', filterAdminUsers);
            document.getElementById('adminTransactionSearch').addEventListener('input', debounce(filterAdminTransactions, 300));
            document.getElementById('adminTypeFilter').addEventListener('change', filterAdminTransactions);
            document.getElementById('adminSortSelect').addEventListener('change', sortAdminTransactions);
            selectUserSearch.addEventListener('input', debounce(filterSelectUser, 300));

            // Document click listener to close dropdowns
            document.addEventListener('click', function(e) {
                if (!transactionDescription.contains(e.target) && 
                    !descriptionDropdown.contains(e.target) && 
                    !descriptionDropdownBtn.contains(e.target)) {
                    descriptionDropdown.classList.add('hidden');
                }
            });

            // Capitalize first letter
            transactionDescription.addEventListener('input', function() {
                const value = this.value;
                if (value.length > 0) {
                    this.value = value.charAt(0).toUpperCase() + value.slice(1);
                }
            });

            // Setup ban notification listener
            setupBanNotificationListener();

            // Setup PWA install prompt
            setupPWA();

            // Check auth state
            checkAuthState();
        }

        // Setup PWA
        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Update UI to notify the user they can install the PWA
                showInstallButton();
            });

            window.addEventListener('appinstalled', () => {
                // Hide the install button
                hideInstallButton();
                showToast('Aplikasi berhasil diinstall!', 'success');
            });

            // Check if the app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                hideInstallButton();
            }
        }

        function showInstallButton() {
            installButton.classList.remove('hidden');
        }

        function hideInstallButton() {
            installButton.classList.add('hidden');
        }

        // Install button click handler
        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('Aplikasi berhasil diinstall!', 'success');
                    } else {
                        showToast('Instalasi dibatalkan', 'info');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // Setup ban notification listener
        function setupBanNotificationListener() {
            database.ref('banNotifications').on('child_added', snapshot => {
                const notification = snapshot.val();
                const notificationId = snapshot.key;
                
                // Check if this notification is for the current user
                if (currentUser && notification.userId === currentUser.uid) {
                    showBanNotification(notification.reason);
                    
                    // Remove the notification after showing
                    database.ref(`banNotifications/${notificationId}`).remove()
                        .catch(error => {
                            console.error('Error removing ban notification:', error);
                        });
                }
            });
        }

        // Show ban notification modal
        function showBanNotification(reason) {
            const banNotificationContainer = document.getElementById('banNotificationContainer');
            
            const modal = document.createElement('div');
            modal.className = 'ban-notification-modal';
            modal.innerHTML = `
                <div class="ban-notification-content">
                    <div class="ban-notification-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Akun Anda Dibanned</h2>
                    <p class="text-gray-600 mb-6">Alasan: ${reason}</p>
                    <button onclick="closeBanNotificationAndLogout()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg">
                        Keluar
                    </button>
                </div>
            `;
            
            banNotificationContainer.appendChild(modal);
        }

        // Close ban notification and logout
        function closeBanNotificationAndLogout() {
            const banNotificationContainer = document.getElementById('banNotificationContainer');
            banNotificationContainer.innerHTML = '';
            logout();
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Toggle description dropdown
        function toggleDescriptionDropdown() {
            if (descriptionDropdown.classList.contains('hidden')) {
                updateDescriptionDropdown();
                descriptionDropdown.classList.remove('hidden');
            } else {
                descriptionDropdown.classList.add('hidden');
            }
        }

        // Update description dropdown
        function updateDescriptionDropdown() {
            const dropdownContent = descriptionDropdown.querySelector('div');
            dropdownContent.innerHTML = '';
            
            if (descriptions.length === 0) {
                dropdownContent.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">Belum ada keterangan</div>';
                return;
            }
            
            descriptions.forEach(description => {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                item.textContent = description.text;
                item.addEventListener('click', function() {
                    transactionDescription.value = description.text;
                    descriptionDropdown.classList.add('hidden');
                    transactionDescription.focus();
                });
                dropdownContent.appendChild(item);
            });
        }

        // Check authentication state
        function checkAuthState() {
            console.log('Checking auth state...');
            
            // Set a timeout to handle the case when auth state doesn't change
            const authTimeout = setTimeout(() => {
                if (!authChecked) {
                    console.log('Auth check timeout, showing login screen');
                    loadingScreen.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    authChecked = true;
                }
            }, 3000);

            auth.onAuthStateChanged(user => {
                clearTimeout(authTimeout);
                authChecked = true;
                console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                
                if (user) {
                    currentUser = user;
                    
                    // Check if user is admin
                    const adminRef = database.ref('admin/uid');
                    adminRef.once('value')
                        .then(snapshot => {
                            const adminUids = snapshot.val();
                            if (adminUids && adminUids.includes(currentUser.uid)) {
                                isAdmin = true;
                                adminBtn.classList.remove('hidden');
                            } else {
                                isAdmin = false;
                                adminBtn.classList.add('hidden');
                            }
                            
                            // Check if user is banned
                            const bannedRef = database.ref(`bannedUsers/${currentUser.uid}`);
                            bannedRef.once('value')
                                .then(snapshot => {
                                    if (snapshot.exists()) {
                                        const banData = snapshot.val();
                                        // Show ban message and logout
                                        alert(`Anda telah dibanned. Alasan: ${banData.reason}`);
                                        logout();
                                        return;
                                    }
                                    
                                    // User is not banned, continue
                                    loginSection.classList.add('hidden');
                                    mainApp.classList.remove('hidden');
                                    
                                    // Reset stats to zero initially
                                    totalBalance.textContent = 'Rp 0';
                                    totalIncome.textContent = 'Rp 0';
                                    totalExpense.textContent = 'Rp 0';
                                    totalTransactions.textContent = '0';
                                    incomeCount.textContent = '0';
                                    expenseCount.textContent = '0';
                                    
                                    // Create user entry in transactions if not exists
                                    createUserEntry(currentUser.uid);
                                    
                                    // Load data immediately
                                    loadAllData();
                                })
                                .catch(error => {
                                    console.error('Error checking banned status:', error);
                                    loginSection.classList.add('hidden');
                                    mainApp.classList.remove('hidden');
                                    // Create user entry in transactions if not exists
                                    createUserEntry(currentUser.uid);
                                    // Load data
                                    loadAllData();
                                });
                        })
                        .catch(error => {
                            console.error('Error checking admin status:', error);
                            isAdmin = false;
                            adminBtn.classList.add('hidden');
                            loginSection.classList.add('hidden');
                            mainApp.classList.remove('hidden');
                            // Create user entry in transactions if not exists
                            createUserEntry(currentUser.uid);
                            // Load data
                            loadAllData();
                        });
                } else {
                    currentUser = null;
                    isAdmin = false;
                    adminBtn.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                }
                
                // Hide loading screen
                loadingScreen.classList.add('hidden');
            });
        }

        // Create user entry in transactions
        function createUserEntry(uid) {
            const userRef = database.ref(`transactions/${uid}`);
            userRef.once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        // Create empty entry for this user
                        //userRef.set({
                            //_created: true,
                            //timestamp: new Date().getTime()
                        //}).catch(error => {
                            //console.error('Error creating user entry:', error);
                        //});
                    }
                })
                .catch(error => {
                    console.error('Error checking user entry:', error);
                });
        }

        // Fungsi untuk memuat semua data
        function loadAllData() {
            if (!currentUser) return;
            
            console.log('Loading all data for user:', currentUser.uid);
            
            const userId = currentUser.uid;
            
            // Load transactions
            const transactionsRef = database.ref(`transactions/${userId}`);
            transactions = [];
            filteredTransactions = [];
            
            transactionsRef.once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        // Skip system keys
                        if (key === '_created') return;
                        
                        const transaction = childSnapshot.val();
                        transaction.id = key;
                        transactions.push(transaction);
                    });
                    
                    filterTransactions();
                    updateStats();
                    
                    // Setup real-time listener for transactions
                    transactionsRef.on('value', snapshot => {
                        transactions = [];
                        snapshot.forEach(childSnapshot => {
                            const key = childSnapshot.key;
                            // Skip system keys
                            if (key === '_created') return;
                            
                            const transaction = childSnapshot.val();
                            transaction.id = key;
                            transactions.push(transaction);
                        });
                        
                        filterTransactions();
                        updateStats();
                    });
                })
                .catch(error => {
                    showToast(`Gagal memuat data transaksi: ${error.message}`, 'error');
                    console.error('Error loading transactions:', error);
                });
            
            // Load descriptions
            loadDescriptions();
        }

        // Fungsi untuk memuat keterangan
        function loadDescriptions() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const descriptionsRef = database.ref(`descriptions/${userId}`);
            descriptions = [];
            
            descriptionsRef.once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const description = childSnapshot.val();
                        description.id = childSnapshot.key;
                        descriptions.push(description);
                    });
                    
                    updateDescriptionsList();
                    
                    // Setup real-time listener for descriptions
                    descriptionsRef.on('value', snapshot => {
                        descriptions = [];
                        snapshot.forEach(childSnapshot => {
                            const description = childSnapshot.val();
                            description.id = childSnapshot.key;
                            descriptions.push(description);
                        });
                        
                        updateDescriptionsList();
                    });
                })
                .catch(error => {
                    showToast(`Gagal memuat daftar keterangan: ${error.message}`, 'error');
                    console.error('Error loading descriptions:', error);
                });
        }

        // Fungsi untuk memperbarui daftar keterangan
        function updateDescriptionsList() {
            if (descriptions.length === 0) {
                descriptionsList.innerHTML = '';
                descriptionsEmpty.classList.remove('hidden');
                return;
            }
            
            descriptionsEmpty.classList.add('hidden');
            descriptionsList.innerHTML = '';
            
            descriptions.forEach(description => {
                const item = document.createElement('div');
                item.className = 'description-item flex justify-between items-center p-3 bg-white rounded-lg mb-2';
                item.innerHTML = `
                    <span class="text-gray-800 text-sm">${description.text}</span>
                    <div class="flex space-x-2">
                        <button onclick="editDescription('${description.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteDescription('${description.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                descriptionsList.appendChild(item);
            });
        }

        // Fungsi untuk menambah keterangan
        function addDescription() {
            const text = newDescriptionInput.value.trim();
            if (!text) return;
            
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const descriptionData = {
                text: text,
                timestamp: new Date().getTime()
            };
            
            database.ref(`descriptions/${userId}`).push(descriptionData)
                .then(() => {
                    showToast('Keterangan berhasil ditambahkan!', 'success');
                    newDescriptionInput.value = '';
                })
                .catch(error => {
                    showToast(`Gagal menambah keterangan: ${error.message}`, 'error');
                });
        }

        // Fungsi untuk menghapus keterangan
        function deleteDescription(id) {
            if (!currentUser) return;
            
            if (confirm('Apakah Anda yakin ingin menghapus keterangan ini?')) {
                const userId = currentUser.uid;
                database.ref(`descriptions/${userId}/${id}`).remove()
                    .then(() => {
                        showToast('Keterangan berhasil dihapus!', 'success');
                    })
                    .catch(error => {
                        showToast(`Gagal menghapus keterangan: ${error.message}`, 'error');
                    });
            }
        }

        // Fungsi untuk mengedit keterangan
        function editDescription(id) {
            const description = descriptions.find(d => d.id === id);
            if (!description) return;
            
            const newText = prompt('Edit keterangan:', description.text);
            if (newText === null || newText.trim() === '') return;
            
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            database.ref(`descriptions/${userId}/${id}`).update({
                text: newText.trim(),
                timestamp: new Date().getTime()
            })
                .then(() => {
                    showToast('Keterangan berhasil diperbarui!', 'success');
                })
                .catch(error => {
                    showToast(`Gagal memperbarui keterangan: ${error.message}`, 'error');
                });
        }

        // Fungsi untuk memperbarui statistik
        function updateStats() {
            console.log('Updating stats...');
            
            // Reset counters
            let income = 0;
            let expense = 0;
            let incomeTransactions = 0;
            let expenseTransactions = 0;
            
            // Calculate totals from all transactions
            if (transactions && transactions.length > 0) {
                transactions.forEach(transaction => {
                    const amount = parseInt(transaction.amount) || 0;
                    if (transaction.type === 'income') {
                        income += amount;
                        incomeTransactions++;
                    } else {
                        expense += amount;
                        expenseTransactions++;
                    }
                });
            }
            
            const balance = income - expense;
            
            // Update UI with formatted values
            totalBalance.textContent = `Rp ${formatCurrency(balance)}`;
            totalIncome.textContent = `Rp ${formatCurrency(income)}`;
            totalExpense.textContent = `Rp ${formatCurrency(expense)}`;
            totalTransactions.textContent = transactions.length;
            incomeCount.textContent = incomeTransactions;
            expenseCount.textContent = expenseTransactions;
            
            // Debug log
            console.log('Stats updated:', {
                income: income,
                expense: expense,
                balance: balance,
                totalTransactions: transactions.length,
                incomeTransactions: incomeTransactions,
                expenseTransactions: expenseTransactions
            });
        }

        // Authentication
        function loginWithGoogle() {
            // Show loading state on login button
            loginBtn.classList.add('btn-loading');
            loginBtn.disabled = true;
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    // Get user info including email
                    const user = result.user;
                    
                    // Save user email to database
                    if (user.email) {
                        database.ref(`userEmails/${user.uid}`).set({
                            email: user.email,
                            timestamp: new Date().getTime()
                        }).catch(error => {
                            console.error('Error saving user email:', error);
                        });
                    }
                    
                    showToast('Login berhasil!', 'success');
                })
                .catch(error => {
                    showToast(`Login gagal: ${error.message}`, 'error');
                })
                .finally(() => {
                    // Remove loading state
                    loginBtn.classList.remove('btn-loading');
                    loginBtn.disabled = false;
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    showToast('Logout berhasil!', 'success');
                })
                .catch(error => {
                    showToast(`Logout gagal: ${error.message}`, 'error');
                });
        }

        // Transaction Management
        function saveTransaction(e) {
            e.preventDefault();
            
            if (!currentUser) return;

            const isAdminMode = document.getElementById('transactionForm').dataset.adminMode === 'true';
            const adminUid = document.getElementById('transactionForm').dataset.uid;
            
            const userId = isAdminMode && adminUid ? adminUid : currentUser.uid;
            const id = document.getElementById('transactionId').value;
            const transactionData = {
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value,
                type: document.getElementById('transactionType').value,
                amount: parseInt(document.getElementById('transactionAmount').value),
                timestamp: new Date().getTime()
            };

            // Show loading state on save button
            saveTransactionBtn.classList.add('btn-loading');
            saveTransactionBtn.disabled = true;

            let saveOperation;
            if (id) {
                // Update existing transaction
                saveOperation = database.ref(`transactions/${userId}/${id}`).update(transactionData);
            } else {
                // Add new transaction
                saveOperation = database.ref(`transactions/${userId}`).push(transactionData);
            }

            saveOperation
                .then(() => {
                    // Check if we need to save the description
                    if (document.getElementById('saveDescription').checked) {
                        const descriptionText = document.getElementById('transactionDescription').value.trim();
                        if (descriptionText) {
                            // Check if description already exists
                            const exists = descriptions.some(desc => 
                                desc.text.toLowerCase() === descriptionText.toLowerCase()
                            );
                            
                            if (!exists) {
                                const descriptionData = {
                                    text: descriptionText,
                                    timestamp: new Date().getTime()
                                };
                                
                                database.ref(`descriptions/${userId}`).push(descriptionData)
                                    .then(() => {
                                        showToast('Keterangan berhasil disimpan ke daftar!', 'success');
                                    })
                                    .catch(error => {
                                        showToast(`Gagal menyimpan keterangan: ${error.message}`, 'error');
                                    });
                            }
                        }
                    }
                    
                    showToast(id ? 'Transaksi berhasil diperbarui!' : 'Transaksi berhasil ditambahkan!', 'success');
                    closeModal();
                    
                    // If admin mode, reopen admin modal and refresh data
                    if (isAdminMode) {
                        setTimeout(() => {
                            openAdminModal();
                            if (adminCurrentTab === 'users') {
                                loadAdminUsers();
                            } else {
                                loadAdminTransactions();
                            }
                        }, 500);
                    }
                })
                .catch(error => {
                    showToast(`Gagal menyimpan transaksi: ${error.message}`, 'error');
                })
                .finally(() => {
                    // Remove loading state
                    saveTransactionBtn.classList.remove('btn-loading');
                    saveTransactionBtn.disabled = false;
                });
        }

        function deleteTransaction(id) {
            if (!currentUser) return;

            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                const userId = currentUser.uid;
                
                // Find the delete button and show loading state
                const deleteBtn = event.target.closest('button');
                deleteBtn.classList.add('btn-loading');
                deleteBtn.disabled = true;
                
                database.ref(`transactions/${userId}/${id}`).remove()
                    .then(() => {
                        showToast('Transaksi berhasil dihapus!', 'success');
                    })
                    .catch(error => {
                        showToast(`Gagal menghapus transaksi: ${error.message}`, 'error');
                    })
                    .finally(() => {
                        // Remove loading state
                        deleteBtn.classList.remove('btn-loading');
                        deleteBtn.disabled = false;
                    });
            }
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('transactionId').value = id;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionAmount').value = transaction.amount;
            
            modalTitle.textContent = 'Edit Transaksi';
            transactionModal.classList.remove('hidden');
        }

        // Modal Management
        function openAddModal() {
            document.getElementById('transactionId').value = '';
            transactionForm.reset();
            transactionDate.valueAsDate = new Date();
            saveDescription.checked = false;
            modalTitle.textContent = 'Tambah Transaksi';
            transactionModal.classList.remove('hidden');
        }

        function openDescriptionsModal() {
            descriptionsModal.classList.remove('hidden');
        }

        function closeDescriptionsModal() {
            descriptionsModal.classList.add('hidden');
        }

        function closeModal() {
            const isAdminMode = document.getElementById('transactionForm').dataset.adminMode === 'true';
            
            transactionModal.classList.remove('transaction-modal-high-z');
            transactionModal.classList.add('hidden');
            transactionForm.reset();
            transactionDate.valueAsDate = new Date();
            delete transactionForm.dataset.adminMode;
            delete transactionForm.dataset.uid;
            
            // If admin mode, reopen admin modal
            if (isAdminMode) {
                setTimeout(() => {
                    openAdminModal();
                    if (adminCurrentTab === 'users') {
                        loadAdminUsers();
                    } else {
                        loadAdminTransactions();
                    }
                }, 500);
            }
        }

        // Admin Functions
        function openAdminModal() {
            adminModal.classList.remove('hidden');
            // Load data based on current tab
            if (adminCurrentTab === 'users') {
                loadAdminUsers();
            } else {
                loadAdminTransactions();
            }
        }

        function closeAdminModal() {
            adminModal.classList.add('hidden');
        }

        function switchAdminTab(tab) {
            adminCurrentTab = tab;
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (tab === 'users') {
                usersTabBtn.classList.remove('border-transparent', 'text-gray-500');
                usersTabBtn.classList.add('border-blue-500', 'text-blue-600');
                usersTabContent.classList.remove('hidden');
                transactionsTabContent.classList.add('hidden');
                loadAdminUsers();
            } else {
                transactionsTabBtn.classList.remove('border-transparent', 'text-gray-500');
                transactionsTabBtn.classList.add('border-blue-500', 'text-blue-600');
                usersTabContent.classList.add('hidden');
                transactionsTabContent.classList.remove('hidden');
                loadAdminTransactions();
            }
        }

        function loadAdminUsers() {
            // Load all users from Firebase
            const usersMap = {};
            userEmails = {};
            
            // Get user emails first
            database.ref('userEmails').once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const emailData = childSnapshot.val();
                        userEmails[uid] = emailData.email || '';
                    });
                    
                    // Get UIDs from transactions
                    return database.ref('transactions').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        usersMap[uid] = { 
                            uid, 
                            email: userEmails[uid] || '', 
                            status: 'active' 
                        };
                    });
                    
                    // Get UIDs from descriptions
                    return database.ref('descriptions').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        if (!usersMap[uid]) {
                            usersMap[uid] = { 
                                uid, 
                                email: userEmails[uid] || '', 
                                status: 'active' 
                            };
                        }
                    });
                    
                    // Now check banned users
                    return database.ref('bannedUsers').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        if (usersMap[uid]) {
                            usersMap[uid].status = 'banned';
                            usersMap[uid].banReason = userSnapshot.val().reason;
                        }
                    });
                    
                    // Convert to array
                    allUsers = Object.values(usersMap);
                    
                    filterAdminUsers();
                })
                .catch(error => {
                    console.error('Error loading admin users:', error);
                    showToast('Gagal memuat data user', 'error');
                });
        }

        function filterAdminUsers() {
            const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
            const statusFilter = document.getElementById('adminUserFilter').value;
            
            let filtered = allUsers;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    user.uid.toLowerCase().includes(searchTerm) || 
                    (user.email && user.email.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(user => user.status === statusFilter);
            }
            
            renderAdminUsersTable(filtered);
        }

        function renderAdminUsersTable(users) {
            const tableBody = adminUsersTableBody;
            const emptyState = adminUsersEmpty;
            
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${user.uid}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${user.email || 'N/A'}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status === 'active' ? 'Aktif' : 'Dibanned'}
                        </span>
                    </td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="viewUserTransactions('${user.uid}', '${user.email || ''}')" class="text-blue-600 hover:text-blue-900" title="Lihat Transaksi">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="addTransactionForUser('${user.uid}', '${user.email || ''}')" class="text-green-600 hover:text-green-900" title="Tambah Transaksi">
                                <i class="fas fa-plus"></i>
                            </button>
                            ${user.status === 'active' ? 
                                `<button onclick="openBanUserModal('${user.uid}', '${user.email || ''}')" class="text-red-600 hover:text-red-900" title="Ban User">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button onclick="unbanUser('${user.uid}')" class="text-green-600 hover:text-green-900" title="Unban User">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function viewUserTransactions(uid, email) {
            selectedUserForTransactions = { uid, email };
            selectedUserInfo.textContent = `${email} (${uid})`;
            viewAllTransactionsBtn.classList.remove('hidden');
            filterAdminTransactions();
            switchAdminTab('transactions');
        }

        function addTransactionForUser(uid, email) {
            selectedUserForTransactions = { uid, email };
            openAddModalForUser();
        }

        function addTransactionForSelectedUser() {
            if (selectedUserForTransactions) {
                openAddModalForUser();
            } else {
                showToast('Silakan pilih user terlebih dahulu', 'warning');
            }
        }

        function openAddModalForUser() {
            if (!selectedUserForTransactions) return;
            
            // Close admin modal first
            adminModal.classList.add('hidden');
            
            document.getElementById('transactionId').value = '';
            transactionForm.reset();
            transactionDate.valueAsDate = new Date();
            saveDescription.checked = false;
            modalTitle.textContent = `Tambah Transaksi untuk ${selectedUserForTransactions.email}`;
            
            // Set admin mode
            transactionForm.dataset.adminMode = 'true';
            transactionForm.dataset.uid = selectedUserForTransactions.uid;
            
            // Show transaction modal with higher z-index
            transactionModal.classList.add('transaction-modal-high-z');
            transactionModal.classList.remove('hidden');
        }

        function viewAllTransactions() {
            selectedUserForTransactions = null;
            selectedUserInfo.textContent = 'Semua User';
            viewAllTransactionsBtn.classList.add('hidden');
            filterAdminTransactions();
        }

        function openBanUserModal(uid, email) {
            document.getElementById('banUserId').value = uid;
            document.getElementById('banUserInfo').textContent = `${email} (${uid})`;
            document.getElementById('banReason').value = '';
            banUserModal.classList.remove('hidden');
        }

        function closeBanUserModal() {
            banUserModal.classList.add('hidden');
        }

        function banUser(e) {
            e.preventDefault();
            
            const uid = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;
            
            // Show loading state
            confirmBanBtn.classList.add('btn-loading');
            confirmBanBtn.disabled = true;
            
            // First, add the user to banned list
            database.ref(`bannedUsers/${uid}`).set({
                reason: reason,
                timestamp: new Date().getTime()
            })
            .then(() => {
                // Then, send a real-time notification to the user
                return database.ref('banNotifications').push({
                    userId: uid,
                    reason: reason,
                    timestamp: new Date().getTime()
                });
            })
            .then(() => {
                showToast('User berhasil dibanned!', 'success');
                closeBanUserModal();
                // Refresh admin users list
                loadAdminUsers();
            })
            .catch(error => {
                showToast(`Gagal membanning user: ${error.message}`, 'error');
            })
            .finally(() => {
                confirmBanBtn.classList.remove('btn-loading');
                confirmBanBtn.disabled = false;
            });
        }

        function unbanUser(uid) {
            if (confirm('Apakah Anda yakin ingin meng-unban user ini?')) {
                database.ref(`bannedUsers/${uid}`).remove()
                    .then(() => {
                        showToast('User berhasil di-unban!', 'success');
                        loadAdminUsers(); // Refresh users list
                    })
                    .catch(error => {
                        showToast(`Gagal meng-unban user: ${error.message}`, 'error');
                    });
            }
        }

        function loadAdminTransactions() {
            // Load all transactions from all users
            allTransactions = [];
            userEmails = {};
            
            // Get user emails first
            database.ref('userEmails').once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const emailData = childSnapshot.val();
                        userEmails[uid] = emailData.email || '';
                    });
                    
                    // Get transactions
                    return database.ref('transactions').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        userSnapshot.forEach(transactionSnapshot => {
                            const key = transactionSnapshot.key;
                            // Skip system keys
                            if (key === '_created') return;
                            
                            const transaction = transactionSnapshot.val();
                            transaction.id = key;
                            transaction.uid = uid;
                            transaction.email = userEmails[uid] || '';
                            allTransactions.push(transaction);
                        });
                    });
                    
                    filterAdminTransactions();
                })
                .catch(error => {
                    console.error('Error loading admin transactions:', error);
                    showToast('Gagal memuat data transaksi', 'error');
                });
        }

        function filterAdminTransactions() {
            const searchTerm = document.getElementById('adminTransactionSearch').value.toLowerCase();
            const typeFilter = document.getElementById('adminTypeFilter').value;
            
            let filtered = allTransactions;
            
            // Apply user filter if a user is selected
            if (selectedUserForTransactions) {
                filtered = filtered.filter(transaction => transaction.uid === selectedUserForTransactions.uid);
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(transaction => 
                    transaction.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply type filter
            if (typeFilter !== 'all') {
                filtered = filtered.filter(transaction => transaction.type === typeFilter);
            }
            
            // Apply sorting
            const sortValue = document.getElementById('adminSortSelect').value;
            filtered.sort((a, b) => {
                switch (sortValue) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'amount-desc':
                        return b.amount - a.amount;
                    case 'amount-asc':
                        return a.amount - b.amount;
                    default:
                        return 0;
                }
            });
            
            renderAdminTransactionsTable(filtered);
        }

        function sortAdminTransactions() {
            filterAdminTransactions();
        }

        function renderAdminTransactionsTable(transactions) {
            const tableBody = adminTransactionsTableBody;
            const emptyState = adminTransactionsEmpty;
            
            tableBody.innerHTML = '';
            
            if (transactions.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">
                        <div>
                            <div>${transaction.email || transaction.uid}</div>
                            ${transaction.email ? `<div class="text-xs text-gray-500">${transaction.uid}</div>` : ''}
                        </div>
                    </td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${transaction.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${transaction.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
                        </span>
                    </td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">Rp ${formatCurrency(transaction.amount)}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="adminEditTransaction('${transaction.uid}', '${transaction.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="adminDeleteTransaction('${transaction.uid}', '${transaction.id}')" class="text-red-600 hover:text-red-900" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function adminEditTransaction(uid, transactionId) {
            // Load the transaction data
            database.ref(`transactions/${uid}/${transactionId}`).once('value')
                .then(snapshot => {
                    const transaction = snapshot.val();
                    if (transaction) {
                        // Close admin modal first
                        adminModal.classList.add('hidden');
                        
                        // Open the transaction modal in admin mode
                        document.getElementById('transactionId').value = transactionId;
                        document.getElementById('transactionDate').value = transaction.date;
                        document.getElementById('transactionDescription').value = transaction.description;
                        document.getElementById('transactionType').value = transaction.type;
                        document.getElementById('transactionAmount').value = transaction.amount;
                        
                        // Set a flag to indicate this is admin edit
                        document.getElementById('transactionForm').dataset.adminMode = 'true';
                        document.getElementById('transactionForm').dataset.uid = uid;
                        
                        const userEmail = userEmails[uid] || uid;
                        document.getElementById('modalTitle').textContent = `Edit Transaksi untuk ${userEmail}`;
                        
                        // Show transaction modal with higher z-index
                        transactionModal.classList.add('transaction-modal-high-z');
                        transactionModal.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    showToast(`Gagal memuat data transaksi: ${error.message}`, 'error');
                });
        }

        function adminDeleteTransaction(uid, transactionId) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                database.ref(`transactions/${uid}/${transactionId}`).remove()
                    .then(() => {
                        showToast('Transaksi berhasil dihapus!', 'success');
                        // Don't refresh the list, just show toast
                        console.log('Admin transaction deleted, not refreshing list');
                    })
                    .catch(error => {
                        showToast(`Gagal menghapus transaksi: ${error.message}`, 'error');
                    });
            }
        }

        // Select User Modal Functions
        function openSelectUserModal() {
            selectUserModal.classList.remove('hidden');
            loadUsersForSelection();
        }

        function closeSelectUserModal() {
            selectUserModal.classList.add('hidden');
        }

        function loadUsersForSelection() {
            // Load all users for selection
            const usersMap = {};
            userEmails = {};
            
            // Get user emails first
            database.ref('userEmails').once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const emailData = childSnapshot.val();
                        userEmails[uid] = emailData.email || '';
                    });
                    
                    // Get UIDs from transactions
                    return database.ref('transactions').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        usersMap[uid] = { 
                            uid, 
                            email: userEmails[uid] || '', 
                            status: 'active' 
                        };
                    });
                    
                    // Get UIDs from descriptions
                    return database.ref('descriptions').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        if (!usersMap[uid]) {
                            usersMap[uid] = { 
                                uid, 
                                email: userEmails[uid] || '', 
                                status: 'active' 
                            };
                        }
                    });
                    
                    // Now check banned users
                    return database.ref('bannedUsers').once('value');
                })
                .then(snapshot => {
                    snapshot.forEach(userSnapshot => {
                        const uid = userSnapshot.key;
                        if (usersMap[uid]) {
                            usersMap[uid].status = 'banned';
                            usersMap[uid].banReason = userSnapshot.val().reason;
                        }
                    });
                    
                    // Convert to array and filter out banned users
                    allUsers = Object.values(usersMap).filter(user => user.status === 'active');
                    
                    filterSelectUser();
                })
                .catch(error => {
                    console.error('Error loading users for selection:', error);
                    showToast('Gagal memuat data user', 'error');
                });
        }

        function filterSelectUser() {
            const searchTerm = selectUserSearch.value.toLowerCase();
            
            let filtered = allUsers;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    user.uid.toLowerCase().includes(searchTerm) || 
                    (user.email && user.email.toLowerCase().includes(searchTerm))
                );
            }
            
            renderSelectUserList(filtered);
        }

        function renderSelectUserList(users) {
            const listContainer = selectUserList;
            const emptyState = selectUserEmpty;
            
            listContainer.innerHTML = '';
            
            if (users.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-white rounded-lg mb-2 cursor-pointer hover:bg-gray-50';
                item.innerHTML = `
                    <div class="font-medium text-gray-900">${user.email || 'Tanpa Email'}</div>
                    <div class="text-xs text-gray-500">${user.uid}</div>
                `;
                item.addEventListener('click', () => selectUser(user.uid, user.email));
                listContainer.appendChild(item);
            });
        }

        function selectUser(uid, email) {
            selectedUserForTransactions = { uid, email };
            selectedUserInfo.textContent = `${email} (${uid})`;
            viewAllTransactionsBtn.classList.remove('hidden');
            closeSelectUserModal();
            filterAdminTransactions();
        }

        // Transaction Filtering and Sorting
        function filterTransactions() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeFilterValue = typeFilter.value;
            
            filteredTransactions = transactions.filter(transaction => {
                const matchesSearch = transaction.description.toLowerCase().includes(searchTerm);
                const matchesType = typeFilterValue === 'all' || transaction.type === typeFilterValue;
                return matchesSearch && matchesType;
            });
            
            sortTransactions();
        }

        function sortTransactions() {
            const sortValue = sortSelect.value;
            
            filteredTransactions.sort((a, b) => {
                switch (sortValue) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'amount-desc':
                        return b.amount - a.amount;
                    case 'amount-asc':
                        return a.amount - b.amount;
                    default:
                        return 0;
                }
            });
            
            renderTransactions();
        }

        function renderTransactions() {
            // Calculate pagination
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredTransactions.length);
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            // Update pagination info
            startItem.textContent = filteredTransactions.length > 0 ? startIndex + 1 : 0;
            endItem.textContent = endIndex;
            totalItems.textContent = filteredTransactions.length;
            
            // Update pagination buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Render page numbers
            pageNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-2 sm:px-3 py-1 border rounded-lg ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => changePage(i));
                pageNumbers.appendChild(pageBtn);
            }
            
            // Render transactions
            transactionsTableBody.innerHTML = '';
            
            if (paginatedTransactions.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            paginatedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${transaction.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${transaction.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
                        </span>
                    </td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-sm text-gray-900">Rp ${formatCurrency(transaction.amount)}</td>
                    <td class="px-3 sm:px-4 lg:px-6 py-2 sm:py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTransaction('${transaction.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction('${transaction.id}')" class="text-red-600 hover:text-red-900" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                transactionsTableBody.appendChild(row);
            });
        }

        function changePage(page) {
            currentPage = page;
            renderTransactions();
        }

        // Utility Functions
        function formatCurrency(amount) {
            return amount.toLocaleString('id-ID');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            // Set background color based on type
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-2 flex items-center`;
            
            // Add icon based on type
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas ${icon} mr-2"></i>
                <span>${message}</span>
                <button class="ml-4 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add close button functionality
            toast.querySelector('button').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            });
            
            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toastContainer.removeChild(toast);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Initialize the app
        initializeApp();
    </script>
</body>
</html>